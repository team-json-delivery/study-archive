# í† ìŠ¤ã…£SLASH 22 - ì• í”Œ í•œ ì£¼ê°€ ê³ ê°ì—ê²Œ ì „ë‹¬ ë˜ê¸°ê¹Œì§€
> https://www.youtube.com/watch?v=UOWy6zdsD-c

## ë™ì‹œì— ë°œìƒí•˜ëŠ” íŠ¸ëœì­ì…˜ì—ì„œ ì•ˆì „í•˜ê²Œ ë™ì‹œì„± ì²˜ë¦¬
- ë°©ì•ˆ 1) FOR UPDATEë¡œ ë½ ì²˜ë¦¬ -> ë°ë“œë½ ë°œìƒ ê°€ëŠ¥ì„±
- ë°©ì•ˆ 2) ë½ì„ ìœ„í•œ í…Œì´ë¸”ì„ ë³„ë„ë¡œ ë‘ê³  ì²˜ë¦¬ -> MSA í™˜ê²½ì—ì„œ ì²˜ë¦¬ ì–´ë ¤ì›€
- í•´ê²° ë°©ì•ˆ) Redis ë¶„ì‚° ë½ì„ ì‚¬ìš©í•œ ë™ì‹œì„± í•´ê²°
  - ë¶„ì‚° ë½ì„ í†µí•´ ëª¨ë“  ì„œë²„ëŠ” ë½ì„ ì¤‘ì•™í™”ëœ Redis ì„œë²„ë¡œë¶€í„° ê³µìœ í•˜ê³ , ì œì–´
  - ì—¬ëŸ¬ ì„œë²„ë“¤ì—ì„œ ëª¨ë‘ ìš”ì²­í•˜ê¸° ë•Œë¬¸ì— ë†’ì€ ì²˜ë¦¬ëŸ‰(throughput) ì´ ë³´ì¥

### Redis ë¶„ì‚° ë½ì˜ ë¬¸ì œì  ë° í•´ê²° ë°©ì•ˆ
- íƒ€ì„ì•„ì›ƒì— ë”°ë¥¸ ê°±ì‹  ë¶„ì‹¤ ë¬¸ì œ(Lost Updates Problem)
- í•˜ë‚˜ì˜ ì“°ë ˆë“œë§Œ ì§„ì… ê°€ëŠ¥í•œë° ë¬´í•œì • ëŒ€ê¸°ì‹œ ë°ë“œë½ ë°œìƒ ê°€ëŠ¥ì„±
- ì‚¬ë¡€

    ```mermaid
    sequenceDiagram
        participant Client1 as í´ë¼ì´ì–¸íŠ¸ 1 (-3000ì›)
        participant Client2 as í´ë¼ì´ì–¸íŠ¸ 2 (-1000ì›)
        participant Redis as Redis (ë¶„ì‚°ë½)
        participant DB as ë°ì´í„°ë² ì´ìŠ¤
    
        Note over DB: ì´ˆê¸° ì”ì•¡ = 3,000ì›
    
        Client1->>Redis: ë½ íšë“ (SETNX lock_account, TTL=5s)
        Redis-->>Client1: ë½ íšë“ ì„±ê³µ
    
        Client1->>DB: ì”ì•¡ ì¡°íšŒ (SELECT balance FROM account)
        DB-->>Client1: balance = 3000
    
        Note over Client1: ì˜ˆìƒë³´ë‹¤ ì‘ì—…ì´ ì˜¤ë˜ ê±¸ë¦¼ (5ì´ˆ ì´ˆê³¼)
    
        Redis-->>Client1: TTL ë§Œë£Œ â†’ ë½ ìë™ í•´ì œ
    
        Client2->>Redis: ë½ íšë“ (SETNX lock_account, TTL=5s)
        Redis-->>Client2: ë½ íšë“ ì„±ê³µ
    
        Client2->>DB: ì”ì•¡ ì¡°íšŒ (SELECT balance FROM account)
        DB-->>Client2: balance = 3000 (ë¬¸ì œ ë°œìƒ!)
    
        Client2->>DB: balance - 1000 ì ìš© (UPDATE account SET balance = 2000)
        DB-->>Client2: ì—…ë°ì´íŠ¸ ì„±ê³µ
    
        Client1->>DB: balance - 3000 ì ìš© (UPDATE account SET balance = 0)
        DB-->>Client1: ì—…ë°ì´íŠ¸ ì„±ê³µ (ê°±ì‹  ë¶„ì‹¤!)
        
        Note over DB: ìµœì¢… ì”ì•¡ = 0ì› (Client2ì˜ ê°±ì‹ ì´ ì‚¬ë¼ì§)
    ```

- í•´ê²° ë°©ì•ˆ
  - ëª…ì‹œì  ì ê¸ˆ (FOR UPDATE ì ˆ) âš ï¸-> ì—¬ëŸ¬ í…Œì´ë¸” íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì–´ë ¤ì›€
  - ì›ìì  ì—°ì‚° ì‚¬ìš© (atomic í•˜ê²Œ ì—°ì‚° ì²˜ë¦¬. mutex, sempahore ë“±) âš ï¸-> DBMSì— ì˜ì¡´ì , ORMê³¼ ì¢‹ì§€ ì•ŠìŒ
  - ê°±ì‹  ì†ì‹¤ ìë™ ê°ì§€ (ë‚™ê´€ì  ë½ ê¸°ë°˜ Version ê´€ë¦¬ì™€ ìœ ì‚¬) âš ï¸-> DBMSì— ì˜ì¡´ì , ORMê³¼ ì¢‹ì§€ ì•ŠìŒ
  - CAS(Compare-And-Set) ì—°ì‚° âœ…
    - JPAì—ì„œ ì œê³µí•˜ëŠ” @OptimisticLocking ì„ ì‚¬ìš©(ë‚™ê´€ì  ë½)
    - ë¶„ì‚°ë½ìœ¼ë¡œ ë™ì‹œì„± ì œì–´(íŠ¸ëœì­ì…˜ ëŒ€ê¸° ë° ì¬ì‹œë„ ì²˜ë¦¬)
    - ë‚™ê´€ì  ë½ìœ¼ë¡œ ê°±ì‹  ë¶„ì‹¤ ë¬¸ì œ í•´ê²° 

## ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì‹œì ì˜ ë¬¸ì œì  ë° í•´ê²°ë°©ì•ˆ
![img_2.png](img_2.png)

- íƒ€ì„ì•„ì›ƒ ë°œìƒì‹œ ì¬ì‹œë„ ëŒ€ìƒìœ¼ë¡œ íŒë‹¨
  - ì¬ì‹œë„ë¥¼ í•˜ê¸° ìœ„í•´ ë©±ë“±í•œ API ì„¤ê³„ í•„ìš” (í† ìŠ¤ ì£¼ë¬¸ ì‹ë³„ì)
- íƒ€ì„ì•„ì›ƒ ë°œìƒì‹œ ì¬ì‹œë„ ìš”ì²­ íŒ¨í„´ ì§€ìˆ˜ ê°„ê²©ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì•…í™” ìµœì†Œí™”
- ì¬ì‹œë„ ì‹¤íŒ¨ì‹œ ë³„ë„ ì˜¤í¼ë ˆì´ì…˜(ëŒ€ì‚¬ ë°°ì¹˜)ìœ¼ë¡œ ì²˜ë¦¬

## ë¸Œë¡œì»¤ ì˜ì¡´ì„± ê²©ë¦¬
- ì™¸ë¶€ ë¸Œë¡œì»¤ê°€ ì¶”ê°€ë  ê²½ìš° ë§¤ë§¤ ì„œë²„ì™€ ê°•ê²°í•© êµ¬ì¡°ì—ì„œ ì˜í–¥ ë°œìƒ
- ì„œë²„ ë ˆë²¨ì—ì„œ ê²©ë¦¬ (ë§¤ë§¤ì„œë²„-ë¸Œë¡œì»¤ -> ë§¤ë§¤ì„œë²„-ë§¤ë§¤ìš”ì²­ì„œë²„-ë¸Œë¡œì»¤)
  ![img_1.png](img_1.png)
- ë‚´ë¶€ ì¸í„°í˜ì´ìŠ¤ë§Œ ë…¸ì¶œí•˜ì—¬ ì™¸ë¶€ ë¸Œë¡œì»¤ ì¶”ê°€ì‹œ ì˜í–¥ ìµœì†Œí™”
- ë¸Œë¡œì»¤ ì²˜ë¦¬ëŸ‰ì— ë”°ë¼ ë§¤ë§¤ ìš”ì²­ ì„œë²„ë§Œ scale-out
- (ì¶”ê°€) ì¹´í”„ì¹´ë¡œ ë©”ì„¸ì§€ ë°œìƒíˆ ìœ ë‹ˆí¬ ì•„ì´ë”” ì²˜ë¦¬ë¡œ ì¤‘ë³µ ë©”ì„¸ì§€ ì²˜ë¦¬
  ![img.png](img.png)
---

## ğŸ§
- ë¬¼ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ë¶„ë¦¬ì˜ MSAê²½í—˜ì´ ì—†ëŠ”ë° ê´€ë¦¬í¬ì¸íŠ¸ê°€ ëŠ˜ì–´ë‚˜ì§„ ì•Šì„ê¹Œ?
- ë ˆì´ì–´ê°€ ì¶”ê°€ë˜ë©´ ê´€ë¦¬ í¬ì¸íŠ¸ê°€ ëŠ˜ì–´ë‚˜ì§€ë§Œ, MSAì˜ ì¥ì ì„ ì‚´ë¦¬ê¸° ìœ„í•´ ë ˆì´ì–´ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ë¼ê³  ìƒê°í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤.
- ë¹„ë™ê¸°ê°€ ë¬´ì¡°ê±´ ì¢‹ì€ê±´ ì•„ë‹ˆì§€ë§Œ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ì•„ë³´ì¸ë‹¤ (ê°œë°œ -> ê¸°íš ì˜ê²¬ë°œì˜)
- ì™œ ì§€ìˆ˜ ê°„ê²©ìœ¼ë¡œ ì¬ì‹œë„ë¥¼ í•˜ëŠ”ê°€?
  - ì§€ìˆ˜ ë°±ì˜¤í”„(Exponential Backoff) : https://en.wikipedia.org/wiki/Exponential_backoff
  - https://aws.amazon.com/ko/blogs/architecture/exponential-backoff-and-jitter/
    - https://gist.github.com/eugene70/87e15438bcde0a71a16c3fc1e7c9bfbc
- ì¹´í”„ì¹´ ë©”ì„¸ì§€ ì²˜ë¦¬ì‹œ ìœ ë‹ˆí¬ ì•„ì´ë””ëŠ” ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ê°€? uuid? ë³„ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬?
