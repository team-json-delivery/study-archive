https://www.borntodare.me/165ad381-9db0-80af-bd9b-e4d184eed3b3

## 개선배경
* 캐시가 만료될때, 전시 서비스 등으로 다른 서비스로 영향 발생
  * Cache Stamped 현상
* 해결방안
  * 캐시 TTL 증가
    * 상품 정보 변경이 반영되지 않는 문제
    * 10시 부터 오픈 상품 -> 10시 2분이 되도 캐싱으로 인해 미오픈
  * 요청에 Lock 걸기
    * 캐시 만료 시점에 다량의 요청이 들어올때
      * 분산락으로 하나의 트래픽만 들어와서 캐싱 처리
    * 다른 요청들의 응답시간 지연 문제
  * 캐시 웜업
    * 배치로 미리 캐싱, 1분주기 캐싱
      * 리모트 캐시 서버 부하로 인한 응답 지연
      * 캐시 웜업 누락시 Cache Stamped 현상
## Hybrid 캐시 도입
![](image.png)
* 리모트 캐시 서버 지연 문제
* 개인화 X, 업데이트 빈도 X, 빈번하게 조회되는 데이터
  * 이러한 캐시의 경우 Local Cache 도 활용하도록 도입
* Local Cache 에는 자주 조회되는 데이터
* Remote Cache 에는 최신 데이터
* 구조
  * Local Cache miss 발생 -> Remote Cache miss 발생 -> Data Base 조회
* 문제
  * 데이터 변경이 바로 반영되지 않음
  * 로컬 캐시마다 TTL이 다름
* Zookeeper 도입
  * Zookeeper 데이터 변경시 Watch 기능을 이용한 변경 이벤트 감지
* Hybrid캐시 도입으로 인해 13.01 TPS 성능 향상
## Auto Cache WarmUp 도입
* AS-IS 캐시 웜업 대상 수동 등록
  * 대용량 트래픽이 예고된 프로모션 페이지 수동 등록 웜업
  * 문제
    * 수동 등록 웜업 누락
    * 자동화 방식 필요성
* PER 알고리즘 적용 검토
  * Cache Stamped 해결로 유명한 PER 알고리즘
  * 캐시 만료 전 일정한 확률로 캐시 새로 갱신 
  * 이슈
    * 의도치 않게 캐시 확률 범위에 벗어난 경우 누락
* 핫 프로모션 콜렉터를 개발하게 됨
![](image%202.png)
* page ID 로 호출될때 최근 호출시간과 누적 호출시간 저장
* 인기/비인기 프로모션 정의
  * 최근 호출된 시간이 과거 인경우 - 비인기 프로모션
  * 최근 호출된 시간이 최신이지만 호출 횟수가 적음 - 비인기 프로모션
  * 최근 호출 시간도 빠르고 누적 호출도 많음 - 인기 프로모션
* 핫 프로모션 콜렉터 요구사항
  * 일관성 있는 결과 필요 -> 원격 저장소
  * 속도 지연 X -> 인메모리 저장소
  * 통계 및 수집 용이 -> 자료구조 지원
  * REDIS 도입
![](image%203.png)
* SortedSet 활용
  * ID 당 최근 호출된 시간 갱신 - score 저장
* Hash 활용
  * ID 당 누적 호출 횟수 저장
![](image%204.png)
* 스테디프로모션/스파이크 프로모션 정의
  * 스테디 프로모션
    * 호출량이 일정하지만, 누적 호출이 많은 프로모션
    * 누적호출이 많은 프로모션 페이지 가중치
  * 스파이크 프로모션
    * SNS 로 인해 트래픽이 갑자기 치솟는 프로모션
    * 최근에 호출된 프로모션 페이지 가중치 
    * 실시간 호출 횟수가 많은 프로모션 가중치
![](image%205.png)
![](image%206.png)
![](image%207.png)
![](image%208.png)
![](image%209.png)
* 준실시간 계산 전략
  * 프로모션 페이지 호출시 id, 누적 횟수 로컬에 저장
  * N초간 주기적으로 프로모션 컬렉터에 전송
* 배치
  * 핫 프로모션 리스트 조회
  * 최신 상품 상태 조회
  * 캐시 웜업
![](image%2010.png)
## 초 단위 Cache Warm Up
* 1분 단위도 캐시 갱신이 느린 경우가 있음
  * 10시부터 판매 한다고 했는데 10시 1시에 프로모션 오픈되는 문제
* RabbitMQ를 활용한 초 단위 트리거
  * Publisher 가 메세지 TTL 1초 발행
  * 큐에 발행되고 1초뒤 메세지 만료
  * 데드레터 큐로 재발행됨
  * 데드레터 큐를 구독하는 컨슈머가 1초후에 메시지 구독
## 궁금한점
* 주키퍼 캐시 스탬피드
  * 주키퍼 만료 시점에 갱신 푸시 했을듯
* Zookeeper 로 변경 데이터 관리
  * -> 카프카로 변경 이벤트 발행 하면 되지 않나?
  * 카프카는 인스턴스 1대만 될듯
* Rabbit MQ DLQ
  * -> 배치 서버를 사용하기 부담스러워서?
  * 그냥 카프카로 1초에 한번씩 발행하면 안되나?
* 핫 프로모션 웜업
  * 사후 데이터 아닌가? 
  * 모르겠다
