# 16장 - 뉴스 피드 설계

## 개요
뉴스 피드 시스템 설계는 사용자에게 개인화된 뉴스 아이템 목록을 제공하는 시스템을 구축하는 것이다. 사용자가 선택한 주제에 따라 역시간순으로 정렬된 뉴스 아이템을 제공한다.

## 16.1 요구사항

### 기능적 요구사항
- 사용자는 관심 주제를 선택할 수 있다 (최대 100개 태그)
- 사용자는 한 번에 10개씩, 최대 1,000개의 영어 뉴스 아이템을 가져올 수 있다
- 시스템은 모든 아이템을 아카이브해야 한다
- 지리적 위치에 관계없이 동일한 아이템을 제공하고, 이후 개인화를 고려한다
- 최신 뉴스 우선 (역시간순 정렬, 근사치 허용)

### 뉴스 아이템 구성요소
- 텍스트 필드: 최대 10,000자 제한
- UNIX 타임스탬프 (생성 시점)
- 초기에는 이미지, 오디오, 비디오 제외 (나중에 최대 10개의 1MB 이미지 고려)
- 부적절한 콘텐츠 필터링 기능

### 비기능적 요구사항
- 일일 활성 사용자 100K명, 평균 10회 요청/일, 백만 뉴스 아이템/일 확장성
- 읽기 요청의 P99 1초 성능
- 사용자 데이터 프라이버시
- 몇 시간까지의 최종 일관성 허용
- 쓰기 고가용성 필수, 읽기 고가용성은 보너스

## 16.2 상위 수준 아키텍처

### 초기 아키텍처
```
소스 → 수집 → Database <- News Feed Service <- Users
```

### 주요 관찰사항
- 수집 서비스는 고가용성 및 예측 불가능한 트래픽 처리 필요 (Kafka 사용 고려)
- 데이터베이스는 모든 아이템 아카이브 + 1,000개 아이템 제공
- 아카이브용 HDFS, 서빙용 Redis 분리 사용

### 상세 아키텍처 구성요소

#### 수집기
- 유효성 검사 수행
  - SQL 인젝션 방지를 위한 값 정제
  - 부적절한 언어 감지 및 검열
  - 차단된 소스/사용자 확인
  - 필수 필드 및 길이 제한 검증

#### 컨슈머
- Kafka 큐에서 데이터 소비 후 HDFS에 저장
- HDFS 테이블 구성:
  - 원시 뉴스 아이템 테이블
  - 사용자 제공 준비 완료 테이블
  - 수동 검토 필요 아이템 테이블

#### 유효성 검사 작업
- 중복 아이템 찾기
- 시간당 특정 태그 아이템 수 제한
- 모든 유효성 검사 교집합 결정
- Redis 캐시 업데이트

## 16.3 사전 피드 준비하기

### 문제점
- 사용자당 여러 (태그, 시간) 쌍 Redis 쿼리 필요
- 높은 읽기 트래픽과 지연 시간 발생 가능

### 해결방안 1: 해시맵 사용
- `{user ID, post ID}` 및 `{post ID, post}` 해시맵 구성
- 저장 요구사항: 최대 800TB (Redis 클러스터 용량 초과 가능)

### 해결방안 2: 샤딩된 SQL 구현
- 해시된 사용자 ID로 테이블 샤딩
- 사용자 ID 랜덤 분산으로 핫 샤드 문제 방지
- 일관된 해싱으로 클러스터 간 64비트 주소 공간 분할

### 해결방안 3: 하이브리드 접근
- 첫 번째 요청: 준비된 피드 사용
- 추가 스크롤: Redis에서 서빙
- 복잡성과 유지보수 오버헤드 증가, 지연 시간과 비용 감소

## 16.4 검증과 콘텐츠 조정

### 16.4.1 사용자 기기의 게시물 변경
- 자동화하기 어려운 유효성 검사 존재 (문맥상 오류, 가짜 뉴스 등)
- 오류 발생 시 게시물 삭제/수정 메커니즘 필요
- GET /posts 엔드포인트에 수정/삭제 이벤트 추가

### 16.4.2 게시물 태깅
- 게시물 전체에 대한 승인/거부 적용
- 태그 vs 필터 구분:
  - 태그: 사용자가 구성
  - 필터: 시스템이 제어 (지역별 규칙, 연령 제한 등)

### Redis 테이블 구조
- `{post ID, post}`: ID로 게시물 가져오기
- `{tag, [post ID]}`: 태그로 게시물 ID 필터링
- `{post ID, [filter]}`: 필터로 게시물 제외

### 16.4.3 조정 서비스
- 클라이언트, 인제스터, ETL 작업, 백엔드의 유효성 검사 통합
- 관리자 기능:
  - 유효성 검사 작업 및 필터 구성
  - 게시물 변경/삭제 조정 결정 실행
- 결정 로깅으로 검토, 감사, 롤백 지원

## 16.5 로깅, 모니터링, 경보

### 모니터링 대상
- 특정 소스의 비정상적인 트래픽 증감
- 유효성 검사 실패율 급증
- 사용자 부정 반응 (신고, 오류 플래그)
- 파이프라인 처리 시간 이상 증가

### 16.5.1 텍스트와 이미지 함께 제공
- 뉴스 아이템당 최대 10개의 1MB 이미지 허용
- 이미지의 특성:
  - 텍스트보다 훨씬 큰 파일 크기
  - 게시물 간 재사용 가능성
  - 다른 유효성 검사 알고리즘 필요

### 16.5.2 고수준 아키텍처
- 동기식 미디어 업로드 (성공/실패 알림 필요)
- 미디어 서비스 클러스터 확장 필요
- CDN 사용으로 지리적 분산 및 고가용성 확보

#### CDN 통합 혜택
- 낮은 지연 시간
- 높은 가용성
- 텍스트와 미디어 분리 저장으로 비용 최적화

## 16.6 기타 논의 가능한 주제 

### 추가 기능
- 동적 해시태그 생성
- 사용자 간 뉴스 아이템 공유
- 실시간 알림 시스템
- 실시간 기사 배포
- 기사 우선순위 부스팅

### 범위 외 고려사항
- 분석 기능
- 개인화 (사용자별 맞춤 100개 아이템)
- 다국어 지원
- 수익화:
  - 구독 시스템
  - 구독자 전용 게시물
  - 비구독자 기사 제한
  - 광고 및 프로모션 게시물