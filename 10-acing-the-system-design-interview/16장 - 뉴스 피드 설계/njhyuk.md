# 16장 뉴스 피드 설계
## 16.1 요구사항
* 사용자는 관심 주제를 선택할 수 있다. 최대 100개의 태그가 있다.
* 사용자는 한번에 10개씩, 최대 천개까지 뉴스 항목 목록을 가져올 수 있다
* 사용자는 최대 천개만 조회하면 되지만, 시스템은 모든 항목을 보관해야 한다
* 사용자의 지리적 위치와 관계없이 동일한 항목을 받을 수 있게 한다음, 위치와 언어 같은 요소를 기반으로 개인화를 고려해야 한다
* 최신 뉴스를 먼저 보여준다. 시간의 역순, 근사치 허용
* 뉴스항목의 구성요소
  * 여러 텍스트 필드
  * 생성된 시간을 나타내는 유닉스 타임스탬프
  * 오디오, 이미지, 동영상 고려하지 않음
* 비기능적 요구사항
  * DAU 10만명, 각각 하루 평균 10회요청, 100만개의 뉴스 항목을 처리할 수 있게 확장 가능해야함
  * P99 지연시간 1초
  * 최종 일관성 허용
  * 쓰기 작업에 고가용성 필요, 읽기 작업 고가용성은 필수는 아님
## 16.2 상위 수준 아키텍처
소스 -> 수집 -> 뉴스항목 <- 뉴스 피드 <- 사용자
* 수집 서비스는 고가용성을 갖추고, 무겁고 예측 불가능한 트래픽을 처리해야 한다. 카프카 고려
* DB는 모든 항목 보관 필요, 사용자에게는 천개만 제공, DB를 두개 쓸 수 있음
* 천개의 항목과 100개 태그에 해당하는 모든 뉴스는 약 1GB, 레디스에 넣을 수 있음
* 보관용으로는 HDFS 같은 분산 샤딩 파일 시스템 사용 가능
* 최종 일관성
  * 사용자 기기가 한시간에 한번만 업데이트하는걸로 서비스 부하 줄이기
  * 짧게 업데이트 요청을 하면 요청 무시
## 16.3 사전에 피드 준비하기
* 사용자의 피드를 사전에 준비함으로써 더 많은 저장 공간을 사용하는 대신 낮은 지연시간 및 트래픽을 얻을 수 있음 
  * {userId, postId} 와 {postId, post} 두 해시맵 준비
    * 용량이 초과될 수 있는 문제
      * {userId, postId} 쌍에 샤딩된 SQL 구현을 사용하기
      * 해싱된 사용자 ID로 샤딩, 노드간에 무작위 분산
## 16.4 검증과 콘텐츠 조정
* 특정 ETL 작업은 일부 게시물에 수동 검토 플래그
* 이러한 게시물은 수동 검토를 위해 승인 서비스로 보내기
* 검토자가 게시물을 스인하면 카프카로 전송, 백엔드에서 소비
### 16.4.1 사용자 기기의 게시물 변경
* 사용자의 기기가 게시물을 캐시하면, 이를 삭제하거나 수정된 버전으로 덮어써야 한다
* GET /posts 로 가져올때 enum 값으로 REPLACE, DELETE 플래그를 두기
### 16.4.2 게시물 태깅
게시물을 태그로 필터링 구현, 3가지 해시맵 사용
* {postId, post}
* {tag, [post ID]}
* {post ID, [filter]}
### 16.4.3 조정 서비스
* 클라이언트, 수집기, ETL, GET /post 요청 총 4곳 모두 검증 수행
* 중복 되지만 안전
## 16.5 로깅, 모니터링, 경보
* 특정 소스로부터 비정상적으로 많거나 적은 트래픽 비율
* 각 개별 소스 내에서 검증에 실패한 항목의 비정상적으로 높은 비율
* 사용자가 기살르 악용이나 오류로 신고하는 등의 부정적 사용자 반응
