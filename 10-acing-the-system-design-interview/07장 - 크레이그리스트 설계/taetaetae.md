## 07. 크레이그리스트 설계
- 크레이그리스트란?
  - 지역별 온라인 광고와 커뮤니티 게시판 웹사이트
  - 구인구직, 주택, 중고물품 거래 등 다양한 생활정보 공유하는 플랫폼
  - https://seoul.craigslist.org/

#### 7.1 사용자 스토리와 요구사항
- 조회자와 게시자
- 게시자
  - 게시물 작성 및 삭제
  - 7일마다 게시물 갱신 가능
- 조회자
  - 지난 7일동안 특정 도시의 모든 게시물 조회 및 검색, 무한 스크롤
  - 결과에 필터링
  - 상세 페이지
  - 게시물 신고
- 게시물
  - 제목, 설명 문단
  - 가격 (단일통화, 통화 변환 무시)
  - 위치
  - 최대 10장의 사진
  - 동영상 추가 될 수 있음
  - 1주일 뒤 자동 삭제
- 비기능적 요구사항
  - 확장성 : 단일도시 최대 천만명 사용자
  - 높은 가용성 : 99.9% 가동시간
  - 높은 성능 : 게시물 작성 후 몇 초 내에 조회 가능, 검색과 게시물 조회의 P99가 1초
  - 보안 : 회원 기능 제공(OpenID Connect)
- 스토리지 요구사항이 낮다 : 모든 데이터를 단일 호스트에 저장이 가능(분산 스토리지 솔루션이 필요하지 않다.)

#### 7.2 API
- 게시물 CRUD, 검색(GET /post?search={search_string})
- 사용자 관리 : 회원가입, 로그인, 탈퇴
- 필터
  - 동네정보
  - 최소/최대 가격
  - 물품 상태

#### 7.3 SQL 데이터베이스 스키마
- User, Post(비정규화처리로 JOIN 불필요), Images, Report

> 필터링 질의시 성능이 나오려나? -> ES 인덱스 활용

#### 7.4 초기 고수준 아키텍처
- 사용자 인증 서비스와 게시물 객체 스토리지를 사용하는 모놀리스
- 클라이언트 프론트엔드 서비스, 맥엔드 서비스, SQL 서비스, 객체 스토리지, 사용자 인증 서비스

#### 7.5 모놀리스 아키텍처
- 트레이드 오프를 설명할 수 있어야 함

#### 7.6 SQL 데이터베이스와 객체 스토리지 사용
- 백엔드 서비스는 SQL서비스에 요청을 보낸다.
- 객체 스토리지를 사용하고 이미지 파일 이외의 내용을 SQL 데이터베이스에 저장하거나
- 이미지 파일을 SQL 데이터베이스에 저장하고 객체 스토리지를 사용하지 않을 수 있다. (장점 : 단순하다.)

#### 7.7 마이그레이션은 번거롭다
- 한 데이터 스토리지에서 다른 스토리지로의 마이그레이션은 일반적으로 까다롭다.
- 스크립트로 작성
  - 기존 데이터 스토리지에서 레코드를 읽고
  - 새로운 데이터 스토리지에 쓰는 작업
- 중복 레코드 쓰기를 방지하기 위해 멱등성 보장
- 체크포인팅 매커니즘 필요
- 순서대로 레코드를 읽어야 하는 문제
- 필요하다면 데이터 센터 내에서 스크립트를 실행
- 쓰기 오류시 로깅을 통히 재시도 처리
- 데이터 마이그레이션은 복잡하고 비용이 많이 드는 작업이므로 가능하면 피해야 한다.

#### 7.8 게시물 작성과 읽기
- 하나의 게시물에 여러 파일이 있을때
  - 클라이언트에서 처리
    - 게시물 등록 성공 이후
    - 이미지 파일을 스토리지에 직접 업로드
    - 지연시간 감소, 적은 리소스
  - 백엔드에서 처리
    - 게시물 등록시 이미지 파일을 백엔드로 전송
    - 백엔드가 이미지 파일을 스토리지에 업로드
    - 모든 이미지를 볼수 있음을 보장, 객체 스토리지 내제화
- 트레이드 오프
- 이미지 파일을 백엔드에서 스토리지로 쓰지만 읽을땐 CDN에서 읽는 방안도 있음 

#### 7.9 기능적 분할
- 지리적 위치 라우팅
- 위치기반으로 트래픽을 서비스
- craigslist -> craigslist-seoul

#### 7.10 캐싱
- LRU 캐시로 인기 게시물 캐싱
- 레디스 사용
- 게시믈 업데이트시 캐시 무효화

#### 7.11 CDN
- CDN을 통해 정적 자원(CSS, JS, 이미지 등) 캐싱
- 용량이 작을 경우 브라우저 캐싱을 통해 성능 향상

#### 7.12 SQL 클러스터로 읽기 확장
- SQL 복제로 읽기 확장

#### 7.13 쓰기 처리량 확장
- SQL 서버의 ExecuteNonQuery는 초당 수천 건의 쓰기를 처리할 수 있다.
- 배치 커밋을 사용해서 각 INSERT 문 로그 플러시 오버헤드를 줄일 수 있다.
- 카프카와 같은 메시지 브로커 사용
  - 조직에 이미 사용할수 있는 카프카 서비스가 있으면 복잡도 상쇄
  - 쓰기가 SQL 팔오워에 도달하는데 시간이 오래걸려 최종 일관성 지속시간이 늘어남
- 더 높은 처리량이 필요하다면 NoSQL
- DDoS 공격을 방지하기 위해 백엔드 클러스터 앞에 속도 제한기 추가 논의

#### 7.14 이메일 서비스
- 게시물이 7일이 되면 갱신 알림 배치 ETL 작업

#### 7.15 검색
- Elasticsearch 사용으로 인덱스 생성

#### 7.16 오래된 게시물 제거
- 크론이나 에어플로우를 사용한 배치 작업
- 오래된 게시물을 제거함으로써
  - 장점
    - 스토리지 유지보수 비용 절감
    - 데이터베이스 작업 속도 향상
  - 단점
    - 데이터를 보관함으로써 얻을 수 있는 분석과 유용한 인사이트 손실
    - 데이터를 필수로 보관해야 할수 있음
    - 삭제된 데이터의 재활용 가능성

#### 7.17 모니터링과 알림
- 오래된 게시물이 제거되지 않았을때
- 이상 감지 사례
  - 추가되거나 제거된 게시물 수
  - 특정 용어의 높은 검색 횟수
  - 부적절한 것으로 신고된 게시물 수

#### 7.18 아키텍처 논의 내용 요약
- 클라이언트, 백엔드, SQL, 캐시, 알림, 검색, 객체 스토리지, CDN, 로깅, 모니터링, 알림, 배치 ETL

#### 7.19 기타 논의 가능한 주제
- 게시물 신고
  - 신고 카운팅 후 게시물 삭제 및 알림
  - 사용자 계정 차단, 차단에 따른 이의 제기
- 점진적 성능 저하
  - 장애를 일으킬 수 있는 가능한 예외 상황은?
    - 이중화
    - 중복 게시글에 대한 처리
- 복잡성
  - 종속성 최소화 : 최소한의 기능
  - 클라우드 서비스 사용으로 유지보수 복잡도 최소화
  - 전체 웹페이지를 HTML로 저장 : 단순한 구조라 가능
  - 관찰 가능성 : 모니터링, 로깅, 알림 등
- 품목 카테고리/태그 : 매핑테이블로 다대다 구현 
- 분석과 추천 : 태그별 품목수, 클릭수, 연락 카운팅, 판매 지수 등
- A/B 테스팅 
- 구독과 저장된 검색
  - 키워드 알림
  - 천만명의 사용자, 한명이 글을 쓰면 그게 맞는지 체크하고, 알림을 보낸다... 성능...
- 검색 서비스 중복 요청 허용 : es 에서 검색시 결과를 캐싱
- 검색 서비스에 중복 요청 피하기 : ..?
- 속도 제한 : 요청 제한
- 대량의 게시물
  - ...?
- 지역 규정
  - 지역 기준으로 서비스 사용을 어디까지 허용할 것인가
  - 당근의... 지역 인증?