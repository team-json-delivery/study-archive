# 12장 플리커 설계
- 이미지와 비디오를 공유하고 상호작용하는 소셜 애플리케이션은 일반적인 면접 주제

## 12.1 사용자 스토리와 기능 요구사항
- 사용자 스토리
  - 다른 사용자가 공유한 사진을 볼수 있음. 사용자는 뷰어
  - 앱은 너비 50px 썸네일 생성 및 표시
  - 사용자는 사진 업로드 가능. 업로드 사용자를 공유자
  - 공유자는 자신의 사진에 대한 접근 제어 설정 가능
  - 사진에는 미리 정의된 메타데이터 필드 존재 -> 공유자 제공
  - 파일 읽기 권한이 있는 뷰어 목록 존재
  - 사진에 댓글 달수 있음, 새 댓글 알림 존재
  - 사진 즐겨 찾기
  - 사진 제목과 설명 검색 가능
  - API등을 통해 프로그래밍 방식으로 다운로드 가능
  - 개인화 간단한 논의
- 논의 하지 않을 몇가지 사항
  - 사진 메타이데이터로 필터링 -> SQL 경로 매개변수로 충족 가능
  - 위치, 시간, 카메라 세부 정보 등 사진 메타데이터
  - 비디오는 논의하지 않음 -> 전문적 지식 필요

## 12.2 비기능적 요구사항
- 비기능적 요구사항
  - 예상되는 사용자 수와 API를 통한 다운로드 수는 얼마?
    - 매일 1PB의 업로드나 10년동안 3.65EB 해당
    - 평균 트래픽은 초당 1GB 이상 -> 트래픽 급증 예상으로 초당 10GB 계획 필요
  - 사진 업로드 직후 즉시 사용 가능? 삭제 즉시 가능? 개인정보 설정 변경 즉시 적용 가능?
    - 사진은 전체 사용자 표시에 몇분 걸릴수 있음 -> 일관성과 지연시간 간에 트레이드 오프, 최종일관성 허용
    - 개인 정보 설정은 더 빨리 적용 필요 -> 삭제된 사진이 모든 저장소 바로 삭제할 필요 없지만, 접근은 바로 금지 필요
  - 고해상도 사진은 높은 네트워크가 필요하기에 어떻게 비용 통제할 것인가?
    - 사용자는 하나의 고해상도 사진만 다운로드 가능
    - 파일 업로드할 때는 한 번에 하나씩 업로드 가능
- 다른 비기능적 요구사항
  - 99.999% 가용성과 같은 가용성 -> 사진 다운로드나 업로드 방해하는 중단 없어야 함
  - 썸네일 다운로드에서는 P99 1초의 높은 성능과 낮은 지연 시간이 필요하지만, 고해상도 사진에서는 필요하지 않음
  - 업로드에는 높은 성능이 필요하지 않음
- 썸네일 생성에 대한 2가지 방식
  - 클라이언트가 요청할 때 마다, 썸네일 생성 -> 비용이 많이 들고 네트워크 지연 발생으로 인해 실현 불가능
  - 파일 업로드 직후 썸네일 생성

## 12.3 고수준 아키텍처
- CDN: 이미지 파일과 이미지 메타데이터 제공
- 파일 저장 서비스: 이미지 파일 업로드를 위한 별도의 분산 파일 저장 서비스
  - CDN이 다양한 데이터 센터에 이미지를 복제하는 데 다소 시간 소요 -> 뷰어 이미지 다운로드 속도 영향 미침
  - CDN이 이미지 파일을 업로드하는 지연 시간이 허용할 수 없을 정도로 느릴 수 있음
  - 파일 저장 서비스에서 파일 삭제 백업 유지 가능

## 12.4 SQL 스키마
- 어떤 사진이 어떤 사용자와 연결돼 있는지 클라이언트 앱에 표시는 SQL 데이터베이스 활용

## 12.5 CDN에서 디렉터리와 파일 구성하기
- 디렉터리 계층 구조는 '사용자 > 앨범 > 해상도 > 파일' -> 날짜도 고려 가능
  - 각 앨범에는 0개 이상의 사진 가능 -> 앨범과 사진의 매핑은 1:N 관계
  - 앨범이 없는 사진은 'default' 앨범 배치
  - 앨범 디렉토리는 다양한 해상도의 여러 이미지 파일 저장 -> 원본 'swans.png', 썸네일 'swans_thumbnail.png'

## 12.6 사진 업로드
- 썸네일 생성은 어디서?
##### 12.6.1 클라이언트에서 썸네일 생성하기
- 장점
  - 백엔드 리소스 절약
  - 썸네일은 작아 네트워크 트래픽에 거의 영향을 주지 않음
- 단점
  - 클라이언트 기기 제어 및 버그 재현이 어려움
  - 서버 보다 더 많은 실패 시나리오 고려(저장 공간 부족 등)
  - 클라이언트 이슈 시, 디버깅 어려움
- 클라이언트 처리는 버그 발생 확률이 높고 해결 비용이 높기에 상당한 리소스와 시간 투자 -> 개발 속도 늦춤
##### 12.6.2 백엔드에서 썸네일 생성하기
- 장점
  - 서비스를 다른 서비스와 동일한 언어와 도구로 제작 가능 -> 안정성 확보
- 단점
  - 더 많은 하드웨어 리소스와 유지하기 위한 엔지니어링 노력 필요
##### 12.6.3 서버 사이드와 클라이언트 사이드 생성 모두 구현하기
- 클라이언트에서 실패하면 서버에서 처리하는 구조
  - 서버 사이드에서만 생성하는 것보다 복잡하지만 클라이언트 생성보단 더 저렴하고 쉬움

## 12.7 이미지와 데이터 다운로드하기
- 이미지와 썸네일은 CDN, 동적 콘텐츠는 SQL에 저장
  - 사진 댓글, 사용자 프로필 정보, 사용자 설정 등이 동적 콘텐츠
- 인기 있는 썸네일과 전체 해상도 이미지는 레디스 캐시 활용 가능

##### 12.7.1 썸네일 페이지 다운로드하기
- 페이지를 보는 도중 이미지 업데이트로 인해 페이징이 밀리게 되면?(2페이지에 11~20이 아닌 10~19로 되는 문제)
  - '?page=<page>&&page_version=<page_version>'로 page_version 활용
  - '?previous_last=<previous_last>'(앞으로 이동) 또는 '?previous_first=<first>'(뒤로 이동)

## 12.8 모니터링과 경보
- 파일 업로드와 다운로드, SQL 데이터베이스 요청을 모니터링하고 경보 필요

## 12.9 기타 서비스
##### 12.9.1 프리미엄 기능
- 사용자에게 프리미엄 기능 제공
  - 전체 해상도 다운로드 및 다른 곳에서 사용하려면 비용 지불
##### 12.9.2 결제와 세금 서비스
- 프리미엄 기능 사용을 위해 걸제와 세금 서비스 필요
##### 12.9.3 검열/콘텐츠 조정
- 콘텐츠 조정이라고 하는 검열 필요 -> 부적절한 콘텐츠 검열
##### 12.9.4 광고
- 구글 애즈를 통한 광고 추가
##### 12.9.5 개인화
- 광범위환 사용자층 수용 및 수익 증대를 위한 개인화된 경험 제공

## 12.10 기타 논의 가능한 주제
- 메타데이터에 대한 일레스틱서치 인덱스 활용
- 사진을 구성하는 더 많은 방법 논의 가능 -> 그룹 개념 추가
- 저작관 관리와 워터마킹 시스템 논의 가능
- 저장 비용을 제어하기 위한 전략 -> 오래된 파일 다른 저장 시스템 사용
- 분석을 위한 배치 파이프라인 생성
- 다른 사용자를 팔로우 하고 알림 수신
- 오디오와 비디오 스트리밍 지원