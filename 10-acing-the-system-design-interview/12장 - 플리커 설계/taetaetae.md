## 12. 플리커 설계

- 목표: 전 세계 대규모 사용자가 사진을 업로드·열람하고, 권한·댓글·즐겨찾기 같은 메타데이터로 상호작용하는 이미지 공유 서비스를 설계한다
- 핵심 포인트: 썸네일은 조회 시마다 생성하지 않고 업로드 직후 비동기 처리로 미리 만들어 저장한다, 클라이언트·CDN·캐시를 적극 활용해 임계 백엔드 부하를 최소화한다, 업로드 파이프라인은 사가/오케스트레이션으로 견고하게 설계한다

---

#### 12.1 사용자 스토리와 기능 요구사항
- 뷰어는 썸네일 그리드를 보고 항목을 선택해 원본을 본다
- 셰어러는 사진을 업로드한다
- 접근 제어는 단순화를 위해 사용자 단위 공개/비공개로 시작한다(사진 단위 세분화는 후속)
- 사진 메타데이터
    - 정적: 제목, 설명, 태그, 촬영 위치 등
    - 동적: 공유 대상, 댓글 허용 여부, 즐겨찾기 여부 등
- 기능
    - 썸네일 그리드, 원본 보기, 업로드
    - 댓글 온/오프, 즐겨찾기, 제목·설명 검색
    - 프로그램적 다운로드(API) 지원

---

#### 12.2 비기능적 요구사항
- 스케일: 10억 사용자 가정, 업로드/다운로드 트래픽 피크에 대비
- 지연과 일관성
    - 업로드 직후 전 세계 전파는 수분 지연 허용(최종적 일관성)
    - 삭제·비공개 전환은 수분 내 접근 차단 보장
- 네트워크 비용 제어
    - 원본 동시 다운로드는 1건만 허용, 썸네일은 병렬 허용
    - 업로드는 파일 단위 직렬 처리 가능(백프레셔)
- 성능 목표
    - 썸네일 다운로드 p99 1초 내외
    - 업로드는 다소 관대하지만 큐 적체 모니터링 필수
- 썸네일 전략
    - CSS 축소로 원본을 내려주는 방식 금지
    - 조회 시 매번 생성 금지
    - 업로드 직후 생성·저장한 썸네일을 조회 시 제공

---

#### 12.3 고수준 아키텍처
- CDN
    - 이미지 파일과 일부 정적 메타데이터 제공
    - 전 세계 에지 캐시와 토큰 기반 접근 제어 연동
- 파일 스토리지 서비스
    - 업로드 버퍼, 중복 체크, 백업, CDN과의 상호작용
    - 업로드 지연·복제 지연을 흡수하는 완충 지대
- SQL
    - 사용자, 접근 권한, 댓글, 즐겨찾기 같은 동적 데이터 저장
- 백엔드
    - 업로드/다운로드 제어, 썸네일 파이프라인 오케스트레이션, 토큰 발급
- 데이터 흐름
    - 다운로드: 클라이언트 → 백엔드에서 권한 확인·토큰 발급 → CDN에서 직접 다운로드
    - 업로드: 클라이언트 → 백엔드 → 파일 스토리지 → CDN 반영

---

#### 12.4 SQL 스키마
- Image
    - cdn_path(pk), cdn_photo_key, file_key, resolution(thumbnail|hd), owner_id, is_public
    - 인덱스: (owner_id, resolution), (cdn_photo_key)
- ImageDir
    - cdn_dir(pk), user_id
- Share
    - id(pk), cdn_photo_key, user_id  (누가 누구의 사진을 볼 수 있는가)
- Favorite
    - id(pk), cdn_photo_key, user_id  (즐겨찾기; 희소 데이터는 별도 테이블)

---

#### 12.5 CDN에서 디렉터리와 파일 구성하기
- 디렉터리 계층: 사용자 → 앨범 → 해상도 → 파일
- 메타데이터 파일은 앨범 디렉터리에 JSON 등으로 저장 가능
- 경로 예시
    - original: nature/original/swans.png
    - thumbnail: nature/thumbnail/swans_thumbnail.png

---

#### 12.6 사진 업로드하기
- 클라이언트 생성 썸네일
    - 단말에서 1차 썸네일 생성 후 원본과 함께 압축 업로드
    - 장점: 네트워크 사용량 감소, 서버 연산 절감
    - 주의: 압축 해제 비용, 다양한 단말 버전·버그 대응 필요
- 서버 생성 썸네일
    - 흐름: 중복 체크 → 파일 스토리지/CDN 업로드 → 썸네일 생성 잡 트리거 → 결과 저장·CDN 반영
    - 사가/이벤트 오케스트레이션: 요청·응답 토픽, 성공/오류 이벤트로 단계 상태를 전달
- 하이브리드
    - 기본은 서버 생성으로 통일, 점진적으로 클라이언트 생성을 도입
    - 클라이언트 버전 코드로 폴백 조건 제어(문제 버전은 서버 생성으로 강제)
- 점진적 배포
    - 신경로 병행 실행·로깅 → 스위치오버 → 문제 시 롤백
    - 모바일 클라이언트는 앱 크기·메모리 제약 고려

---

#### 12.7 이미지와 데이터 다운로드하기
- 권한 확인과 토큰
    - 백엔드가 Share 테이블로 접근 가능한 셰어러를 확인
    - Image 테이블에서 썸네일 cdn_path 목록 조회 후, CDN 읽기용 임시 토큰을 발급
    - 클라이언트는 CDN에서 직접 다운로드
- 캐시 전략
    - 인기 썸네일/원본은 Redis·CDN 캐시로 가속
    - 즐겨찾기는 클라이언트 캐시로 즉시성·오프라인 지원
- 페이지네이션 일관성
    - 새 항목 유입으로 경계가 흔들리지 않도록 page_version을 부여해 스냅샷 고정
    - 또는 previous_first/previous_last 기준 탐색으로 앞뒤 페이지 일관성 확보

---

#### 12.8 모니터링과 경보
- 업로드 파이프라인
    - 큐 적체, 실패율, 썸네일 생성 지연, 리트라이 횟수
- CDN/다운로드
    - 히트율, 토큰 검증 실패율, p95/p99 지연
- SQL
    - 쿼리 지연, 락 대기, 핫 파티션, 에러율
- 운영 알림
    - 임계치 초과 시 경보, 자동 롤백/폴백 훅, 대시보드 시각화

---

#### 12.9 기타 서비스
- 유료화
    - 용량·대역 초과 과금, 광고 제거 구독, 저작권 판매 대시보드
- 검열/콘텐츠 조정
    - 신고, 운영자 도구, 자동화(휴리스틱·ML), 지역별 규제 대응
- 개인화·추천·광고
    - 조회/즐겨찾기 로그 기반 추천, 프로모션 노출, 실험 플랫폼과 연계
- 데이터 거버넌스
    - GDPR/삭제 요청 준수, 보존 기간, 접근 감사 로그

---

#### 12.10 기타 논의 가능한 주제
- 멀티 리전과 재해 복구, 캐시 무효화의 정확성
- 업로드 속도 제한·백프레셔·대용량 업로드 재개
- 데이터 마이그레이션 전략
- CDN 자체 설계로의 확장(토큰·프리사인·서명 URL, 핫 오브젝트 보호)
