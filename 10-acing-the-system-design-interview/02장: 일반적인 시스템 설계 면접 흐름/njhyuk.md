# 2장: 일반적인 시스템 설계 면접 흐름
* QPS와 P99 지연시간 같은 기능적/비기능적 요구사항 명확히 구분
  * 단순한 시스템에서 시작해 설계하기를 원하는지
  * 또는 즉시 확장 가능한 시스템 설계를 원하는지 물어보기
* 트레이드 오프
* 면접을 주도한다, 계속해서 논의 주제를 제안한다
* 시간을 신경쓴다
* 로깅, 모니터링, 경보, 감사를 논의한다
* 디버깅, 복잡성, 보안 프라이버시, 테스트, 유지보수성을 논의한다
* 성능저하와 실패를 논의한다
* 다이어그램, 순서도, 시퀀스 다이어그램을 그린다
* 시스템은 항상 개선될 수 있다
## 2.1 요구사항 명확화와 트레이드 오프 논의
* 기능 요구사항은 면접시간의 20% 이상을 차지하기에 10분 이내에 논의해야함
* 30초에서 1분정도 비즈니스 요구사항 논의부터 시작
* 사용자 범주/역할을 고려한다
  * 누가 이 시스템을 어떻게 사용할건지
  * 기술적인지, 비기술적인지
  * 사용자 역할 나열
  * 기능적/비기능적 요구사항의 수치
  * 국제화, 현지화, 지원국가, 지역언어, 우편주소, 가격, 다중통화 지원
  * DAU를 추정하고 시간단 요청 빈도 추정
  * 어떤 사용자가 어떤 데이터에 접근할 수 있는지? 인증과 인가
  * 검색과 관련하여 가능한 사용 사례
  * 분석 (A/B 테스트, 머신러닝)
  * 의사코드를 작성하고 사용자 스토리와 일치
## 2.2 API 명세 초안 작성
5분 미만으로 GET, POST, PUT, DELETE 엔드포인트 초안을 작성한다
### 2.2.1 공통 API 엔드포인트
* 상태 확인
* 회원가입/로그인
* 사용자와 콘텐츠 관리
## 2.3 사용자와 데이터 간의 연결과 처리
* 1단계
  * 각 사용자 유형을 나타내는 부분을 그린다
  * 기능 요구사항을 제공하는 각 시스템을 그린다
  * 사용자와 시스템 간의 연결을 그린다
* 2단계
  * 요청 처리와 저장소를 분리한다
  * 비기능적 요구사항을 기반으로한 다양한 설계를 만든다
  * 공유 서비스를 고려한다
* 3단계
  * 시스템을 구성요소로 나누다
  * 연결을 그린다
  * 로깅, 모니터링, 경보, 보안 고려
* 4단계
  * 시스템 설계에 관한 요약 포함
  * 새로운 추가 요구사항 제공
  * 내결함성 분석
## 2.4 데이터 모델 설계
처음부터 설계할지, 기존 데이터베이스를 사용할지 논의
### 2.4.1 데이터베이스를 공유하는 여러 서비스의 단점의 예
지표서비스는 주문 데이터를 주문 서비스에 의존한다.
* 지표를 검색한다
* 주문 서비스에 관련 데이터를 검색한다
* 지표를 계산한다
* 지표 값을 반환한다
두 서비스가 같은 DB를 공유한다면 주문 서비스의 테이블을 SQL 쿼리로 수행한다
* 주문팀에서 주문테이블엔 1년간의 주문만 포함하고, 오래된 주문은 아카이브 테이블에 이동하려 한다
* 지표팀이 해당 변경사항에 반대할 수 있어 생산성 향상 달성이 어렵게 된다
### 2.4.2 동시 사용자 업데이트 충돌을 방지하는 기법
* 잠금 테이블을 만들 수 있다
  * unix_locked 라는 타임 스탬프 열
  * edit_username
  * edit_email
* 한 사용자가 일정 기간(10분) 동안 구성을 잠그고, 다른 사용자는 잠겨 있음을 발견하는 것이다
## 2.5 로깅, 모니터링, 경보
### 2.5.1 모니터링의 중요성
* 웹 서비스는 언제든 실패할 수 있다.
* 긴급성이 높은 실패는 즉시 처리 필요하다.
* 서비스가 다른 서비스들의 의존성이라면 성능 저하가 전파됨, 로깅과 모니터링 설정이 필요하다.
### 2.5.2 관찰 가능성
* 특정 엔드포인트의 성능개선 배포가 잘 작동했는지, 그렇지 않다면 관련 통찰을 측정에서 도출 할 수 있어야 함
  * 지연시간
  * 트래픽
  * 오류
  * 포화 (CPU, 메모리 등 초과해서는 안되는 목표)
* 모니터링과 경보의 세가지툴
  * 메트릭 - 오류수, 지연시간, 처리 시간 
  * 대시보드
  * 경보 - 알림
* 커스텀 모니터링
  * 캐시를 구축한다면, 캐시 결함, 히트, 미스를 메트릭에 포함 해야함
### 2.5.3 경보 대응
* 온콜 일정을 설정할 수 있음, 대응 절차 (런북) 을 준비해야함
  * 런북이 쉽다면 자동화 해야함
* 장애 해결 후에 사후분석 (포스트모템)을 작성 해야함
  * 비난이 없어야함
  * 그렇지 않으면 숨기게 됨
### 2.5.4 애플리케이션 수준 로깅 툴
* ELK 구축
* 무료 모니터링 툴
  * 프로메테우스 + 그라파나
  * 센수
  * 나기오스
  * 자비스
* 시계열 데이터 베이스
  * 그라파이트
  * 프로메테우스
  * influxDB
### 2.5.5 데이터 품질에 대한 스트리밍과 배치 감사
* 데이터품질이 낮다의 정의
  * ex) ETL 작업에서 일부 행의 누락 된다
* 주기적으로 감사할 수 있음
  * 조용한 오류 탐지
### 2.5.6 데이터 이상 탐지
머신러닝으로 탐지
(평소보다 주문량이 떨어졌다 등)
### 2.5.7 무감지 오류와 감시
상태 200을 반환하는 무감지 오류, 감사 ETL을 작성하여 대응
## 2.6 검색창
### 2.6.1 소개
일반적 기법
* SQL LIKE 쿼리
* match-sorter 와 같은 라이브러리, 클라이언트에 구현 (GB 단위)
* 일래스틱 서치와 같은 검색엔진 (PB 단위)
### 2.6.2 일래스틱서치를 활용한 검색창 구현
* 정확한 일치만 허용하는 쿼리 (?q=keyword)
* JSON 요청 쿼리 (일래스틱 DSL)
### 2.6.3 일래스틱서치 인덱스와 수집
주기적 혹은 이벤트 트리거 방식의 인덱싱이나 벌크 API 사용, 인덱스 최신화 할 수 있음
### 2.6.4 SQL 대신 일래스틱서치 사용하기
* SQL 대신 일래스틱서치를 사용하여 검색과 쿼리를 모두 할 수 있음
* 하지만 보통은 RDB를 보완하는 용도로 사용, 정규화가 안됨
## 2.7 기타 논의 가능한 주제
### 2.7.1 애플리케이션 유지보수와 확장
* 개발이 끝나는 경우가 없다, 항상 새롭고 경쟁적인 요구사항
* 유지보수는 면접 중의 논의될 수 있다
  * 호환성을 깨는 변경을 어떻게 처리할 것인가
  * 어떤 구성요소가 가장 많은 유지보수가 필요한가
  * 향후 개발해야 할 수 있는 기능과 설계 논의
  * 향후 필요하지 않을수 있는 기능과 fadeout 논의
### 2.7.2 다른 유형의 사용자 지원
다른 유형의 사용자를 지원하게 되면 서비스를 확장하 수 있음 (소비자나, 기업, 프로그래밍)
### 2.7.4 사용성과 피드백
* 사용자 인터페이스 사용 용이성 평가
  * 대시보드를 구현하는 배치 ETL 구현
  * 검색엔진이라면 사용자의 클릭 수 (얼마나 원하는 결과를 찾았는가)
* 사용자 피드백 제출 UI 구현
### 2.7.5 에지케이스와 새로운 제약 조건
* 신용카드 결제를 지원하는 판매 서비스를 설계했는데, 국가마다 다른 요구사항을 지원하게 해야한다면?
* 텍스트 검색 서비스를 설계했는데, 오디오/비디오로 확장해야 한다면?
#### 확장성과 성능
* 사용자가 백만명의 팔로워를 가지고 있다면?
* 지난 10년간 판매 데이터를 감사 해야 한다면?
#### 지연 시간과 처리량
* P99 메세지 전송 시간이 500ms 이내여야 한다면?
* 실시간 스트리밍이 아닌 서비스인데, 지원해야 한다면?
#### 가용성과 내결함성
* 판매 서비스가 고빈도의 거래에 사용된다면 가용성을 어떻게 높일까?
* 시스템의 각 구성요소가 어떻게 실패할 수 있을까?
#### 비용
* 낮은 지연시간과 높은 성능을 지원하는데 비용이 많이 드는 설계를 했다면? 비용을 낮추려면?
### 2.7.6 클라우드 네이티브 개념
마이크로서비스, 서비스메시, 사이드카, 컨테이너화, 오케스트레이션(쿠버네티스) 등등의 논의를 할 수 있음
## 2.8 면접 후 회고와 평가
### 2.8.1 면접 직후 회고록 작성하기
* 면접 회사, 날짜, 질문, 다이어그램
* 면접을 10분 단위로 나누기
* 기억할 수 있는 면접의 세부사항 (내 답변, 면접관의 말)
### 2.8.2 평가 작성하기
면접에서 자신이 보여준 능숙한 영역과 부족한 영역에 대해 평가
### 2.8.3 언급하지 않은 세부 사항
* 50분 내애 모든 내용을 논의 하는 것은 불가능함
  * 왜 논의하지 않기로 선택했는지 되묻기
  * 시간이 부족했는지, 시간 관리할 방법 찾기
  * 내용에 익숙하지 않았는지
  * 컨디션이 안좋았는지
* 질문에 관한 자료 찾기
### 2.8.4 면접 피드백
면접 피드백을 요청해야함, 요청은 해가 되지 않는다
## 2.9 회사 면접하기
* 인생의 향후 몇년을 투자하고 싶은 회사인지 결정하기 위해 질문하기
* 회사의 엔지니어링 블로그와 기사 잘 읽어보기
## 요약
* 모든 것은 트레이드 오프
* 시간은 신중히 사용
* 시스템 요구사항을 명확히 하는것으로 시작
* API 명세 작성
* 사용자와 데이터 간의 연결 그리기
* 로깅, 모니터링, 알림, 검색과 논의 과정에서 제기되는 다른 문제 논의하기
* 면접 후에는 자기 평가 작성하고 강점과 약점 파악하기
* 회사에 몇년을 투자할 수 있는지 판단하고 질문하기
