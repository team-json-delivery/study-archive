## 11. 자동 완성/타입어헤드

- 자동완성 시스템 설계
- 지속적으로 대량의 데이터를 수집하고 처리해 특정 목적으로 사용자가 쿼리할 수 있는 작은 데이터 구조로 만드는 분산 시스템 설계 능력 테스트
 
#### 11.1 자동 완성의 가능한 사용 사례
- 검색 보완: 일반 검색 또는 특정 컬렉션(위키, 동영상 앱 등) 내에서 입력 중 제안 제공
- 문서 편집기: 단어/구 자동완성, 옵션으로 오타 교정
- IDE/개발도구: 심벌·파일·명령 팔레트 자동완성(정확 매칭 중심)
- 폼 입력/소셜: 주소, 태그, 멘션, 이메일 도메인 자동완성
- 전자상거래: 카테고리·브랜드·상품명 추천으로 전환율 향상
- 도메인 특화: 의학·법률 등 전문 용어 사전과 연동
- 면접 시 유의: 처음부터 “검색용 자동완성”으로 단정하지 말고 범위를 합의

---

#### 11.2 검색 vs 자동 완성
- 공통점
    - 의도에 맞게 가능성 높은 순서로 결과 목록을 반환
    - 부적절 콘텐츠 사전 차단
    - 사용자 입력/클릭 로그로 품질 개선
- 차이점
    - 결과 타입: 검색은 문서/URL, 자동완성은 문자열 리스트
    - 지연시간: 검색은 상대적으로 관대, 자동완성은 P99 100ms 수준 요구
    - 피드백: 검색은 다클릭·체류시간 등 복합 신호, 자동완성은 상위 5~10개 노출과 즉시 클릭·무시가 주 피드백
    - UX 제약: 타이핑 중 맥락 변화가 잦아 디바운스·요청 취소·캐시가 중요

---

#### 11.3 기능 요구사항
- 범위
    - 일반 검색 서비스의 검색어 제안으로 한정
    - 언어는 영어부터 시작
    - 최대 10만 단어 지원(신조어 포함), 수동 단어/구 추가 가능
- UX 세부
    - 1차는 단어 중심, 필요 시 구/문장으로 확장
    - 최소 3자 입력 후 제안 노출
    - 6자 이상 단어만 제안(짧은 단어 유용도 낮음 가정)
    - 영문자만 처리, 숫자/특수문자 무시, 소문자화
    - 한 번에 10개 반환, 빈도(인기) 순 정렬, 개인화는 후속 과제
- 검색 기록·데이터 소스
    - 초기에는 전체 사용자 데이터를 기반으로 품질 산출
    - 기간 필터는 느슨하게 시작, 운영 비용/정확도에 맞춰 롤업·컷오프 적용
    - 사전/사후 수동 편집이 가능하도록 분석 친화 스키마 고려
- 콘텐츠 조정과 공정성
    - 신고 기능은 후순위로 두되 확장 여지 확보
    - 특정 사용자가 누구인지보다는 문자열 자체만 고려

---

#### 11.4 비기능 요구사항
- 글로벌 스케일 지원
- 가용성은 핵심 서비스보다 낮게 잡아 내결함성 일부 양보 가능
- 성능/처리량 목표: 사용자는 0.5초 이내 제안을 기대, 바람직한 응답은 수십 ms
- 일관성 강제 불필요: 제안 신선도는 수시간~1일 지연 허용 가능
- 보안/프라이버시: 인증 없이 사용 가능하더라도 수집 데이터는 비공개로 관리

---

#### 11.5 고수준 아키텍처 수립
- 사용자 입력 경로
  - 클라이언트 → 자동완성 API → 제안 반환
  - 프런트엔드에서 디바운스·요청 취소·캐시·레이트 리미팅 수행
- 데이터 수집 경로
  - 검색/클릭 로그를 수집 인프라로 모으고, 배치/스트리밍 파이프라인에서 정제
- CQRS 분리
  - 수집·가공·배포(오프라인)와 제안 질의(온라인)를 논리적으로 분리
- 배포/버전
  - 지역별 스냅샷 롤아웃, 버전 태그·롤백, 카나리 전환

---

#### 11.5 상위 수준 아키텍처 계획
- 사용자 입력 경로
  - 클라이언트 → 자동완성 API → 제안 반환
  - 프런트엔드에서 디바운스·요청 취소·캐시·레이트 리미팅 수행
- 데이터 수집 경로
  - 검색/클릭 로그를 수집 인프라로 모으고, 배치/스트리밍 파이프라인에서 정제
- CQRS 분리
  - 수집·가공·배포(오프라인)와 제안 질의(온라인)를 논리적으로 분리
- 배포/버전
  - 지역별 스냅샷 롤아웃, 버전 태그·롤백, 카나리 전환

---

#### 11. 6 가중치 트라이(Trie) 접근법과 초기 고수준 아키텍처
- 파이프라인 개요
  - 공유 로깅 서비스에 누적된 검색 문자열을 단어 처리 ETL로 정제
  - 단어 빈도 테이블에서 가중치 트라이 생성
  - 자동완성 백엔드로 트라이를 배포하여 질의에 응답
- 동작 원리
  - 접두어 노드에 상위 후보 Top-K를 저장
  - 후보 랭킹은 전역 인기·최근성·클릭률·품질 패널티 등을 가중치로 결합
- 갱신
  - 압축된 트라이 스냅샷을 원자적 교체 방식으로 롤링 업데이트
  - 클라이언트 사이드 트라이(옵션)와 CDN 캐시로 네트워크·지연 편차를 흡수

---

#### 11.7 상세 구현
- 단계화된 DAG
  1) 로그 취득
  2) 문자열 분할·정규화(토큰화, 소문자화, 숫자/기호 제거, NFKC 등)
  3) 부적절 단어 제거(금칙어 사전·규칙 기반)
  4) 단어 카운트(정확 또는 근사)
  5) 적절 단어 필터 및 인기 미등록 단어 추출
  6) 가중치 트라이 생성
  7) 서빙 계층 배포
- 태스크 분리
  - 각 단계를 독립 태스크로 구성하여 리트라이·모니터링·스케일 조정 용이
  - Airflow 같은 스케줄러로 성공적 종료 후 다음 단계 수행
- 로그 적재
  - Elasticsearch 등에서 HDFS/데이터 레이크로 일별 증분 추출
  - 파티셔닝 전략: 입력은 서비스 기준, 출력은 날짜 기준
- 문자열 전처리
  - 길이 필터(6자 이상), 언어 필터(영어), 공백·문장부호 처리
- 부적절 단어 필터링
  - Words 서비스(간단 UI·백엔드·SQL)로 적절/부적절 리스트 관리
  - 리스트는 정렬·캐시 가능하며 주기적 재생성으로 일관성 유지
- 퍼지 매칭·오타 교정
  - 편집거리·키보드 인접성·음운 규칙 등을 병행
  - 독립 모듈로 두어 알고리즘 교체와 신조어 반영을 쉽게 함
- 카운팅
  - 정확 집계(MapReduce/Spark) 또는 근사 집계(Count–Min Sketch)
- 적절 단어 필터와 미등록 단어 관리
  - 카운트 후 스케일이 줄어든 시점에 필터 적용
  - 상위 인기지만 리스트에 없는 단어는 운영 검토 큐로 올려 분류
- 트라이 생성 및 배포
  - 상위 적절 단어 리스트를 이용해 단일 호스트에서 빌드
  - 자동완성 서비스가 스냅샷을 받아 원자적 교체
  - 트라이가 충분히 작으면 클라이언트로 내려 캐시·오프라인 질의도 가능

---

#### 11. 8 샘플링 접근 방식
- 도입 배경
  - 전량 처리 대비 메모리·빌드 시간·운영 복잡도가 크게 줄어듦
  - 단일 호스트 처리 가능 수준으로 축소
- 샘플링 위치
  - 로깅 단계의 검색 문자열 원본에서 샘플링
  - 단어 분할·길이 필터 후에 샘플링
  - 적절 단어 필터 후에 샘플링
- 트레이드오프
  - 롱테일 품질 저하 가능성
  - 최소 노출 임계, 보호 규칙, 주기적 전량 리프레시로 보완

---

#### 11.9 저장소 요구 처리
- 테이블 체인 설계
  - 원시 검색요청(시각/사용자/문자열)
  - 분할 단어(날짜, 단어)
  - 단어 판별 결과(날짜/사용자/단어, 적절 여부)
  - 단어 카운트 결과
  - 가중치 트라이 산출물
- 용량 계획 예시
  - 10억 사용자 × 1일 10검색 × 평균 20자 ≈ 200GB/일
  - 연 73TB 수준 가능, 샘플링·롤업으로 비용 제어
- 롤업/보관
  - 시→일→주→월 순 롤업으로 행 수를 단계적으로 축소
  - 로깅 서비스 보관 14~30일, 트라이는 주간/월간 롤업 기반 생성
- 콜드 스토리지
  - 과거 스냅샷 장기 보관해 롤백·리그레션 분석에 활용

---

#### 11. 10 단일 단어 대신 구문 처리하기
- 길이 정책
  - 최소 5자 원칙 유지
  - 최댓값은 UX/성능/비용 트레이드오프로 결정(예: 30자부터 시작해 조정)
- 인덱싱
  - n-gram 또는 단어 경계 기반 접두어 인덱싱
- 부적절 제안 방지
  - 구 안에 부적절 단어 하나라도 포함되면 전체 구 차단
  - 문구 레벨 필터링은 복잡·대규모 문제이므로 휴리스틱과 ML 조합을 현실적으로 적용

#### 11. 11 로깅, 모니터링과 경보
- 핵심 지표
  - 제안 노출수, CTR, 타이핑부터 클릭까지 시간
  - p95/p99 지연, 에러율, 입력당 요청 수
- 품질 감사
  - 아무 제안도 반환되지 않은 질의 비율을 별도 모니터링(스냅샷·파이프라인 이상 신호)
  - 금칙어 누락, 랭킹 리그레션에 대한 알림
- 안정성
  - 샤드 불균형·업데이트 실패·지연 상승 시 경보와 자동 롤백

---

#### 11. 12 기타 논의 가능한 주제
- 상시 상위권 단어는 상수 리스트와 근사 기법으로 계산량 절약
- 트렌딩 검색어, 추천 시스템 등 파생 서비스로 로그 재활용
- 분산 로깅 서비스와 개인화 자동완성으로 확장
- 람다 아키텍처
  - 빠른 파이프라인(초·분 단위, 정확도 낮음)과 느린 파이프라인(정확도 높음) 병행
  - 업스트림 장애 시 구버전으로 우아한 강등
  - 전단 레이트 리미터로 DoS 방어
- 철자 제안 서비스는 자동완성과 구분해 독립 실험·배포(멀티암드밴딧 등)로 효과 검증