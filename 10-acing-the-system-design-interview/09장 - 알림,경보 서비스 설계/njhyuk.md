# 9장 알림/경보 서비스 설계
## 9.1 기능 요구사항
### 9.1.1 가동 시간 모니터링 용이 아님
* 조직에 영향을 미치는 중단이 이 서비스에도영향을 미칠 수 있다.
* 가동 시간 모니터링 서비스는 모니터링하는 서비스와 독립된 인프라에서 실행되어야 한다.
* 이러한 이유로 PagerDuty와 같은 외부 가용성 모니터링 서비스가 널리 사용된다.
### 9.1.2 사용자와 데이터
* 발신자 : 알림을 CRUD 하고 수신자에게 보내는 사람이나 서비스
* 수신자 : 알림을 받는 앱의 사용자.
* 관리자 : 관리자 접근 권한이 있는 사람. 템플릿 생성 및 관리
### 9.1.3 수신자 채널
* 브라우저
* 이메일
* SMS
* 자동전화 통화
* 푸시 알림
### 9.1.4 템플릿
$name 님 환영합니다. 와 같은 기능 제공
### 9.1.5 트리거 조건
수동방식이나 프로그래밍 방식으로 트리거
### 9.1.6 구독자, 발신자 그룹, 수신자 그룹 관리
한명 이상의 수신자에게 알림을 보내고자 할때 수신자 그룹을 관리하는 기능 제공
### 9.1.7 사용자 기능
* 중복 알림을 보내선 안됨
* 과거 알림 요청을 볼 수 있어야 함
* 알림 구성과 템플릿을 저장할 수 있어야함
* 알림 상태를 조회할 수 있어야함
* 우선순위가 높은 알림을 먼저 처리해야함 (가중치 접근법)
### 9.1.8 분석
알림 분석에 대해 논의해 볼 수 있음 (도달율?)
## 9.2 비기능적 요구사항
* 스케일 : 매일 수십억개의 알림을 보낼 수 있어야함
* 성능 : 알림은 몇 초 내에 전달 되어야함
* 고가용성 : 99.999%
* 내결함성 : 수신자가 알림을 받을 수 없으면 다음 기회에
* 보안 : 인증된 사용자만 알림
* 프라이버시 : 수신자는 알림을 수신 거부 
## 9.3 초기 고수준 아키텍처
* 고려사항
  * 알림 생성을 요청하는 사용자는 단일 인터페이스가 있는 단일서비스를 통해 수행
  * 그러나 각 채널은 별도의 서비스로 처리
  * 공통 채널 서비스 로직을 다른 서비스에서 중앙 집중화, 작업 생성기
  * 다양한 채널 알림은 타사 서비스에서 처리할 수 있음. 요청 속도를 제한해야할 수 있음.
* 초기 설계
  * 프론트엔드
  * 백엔드 서비스
    * 프로듀서 호스트
      * 알림 카프카 토픽에 메세지 생성 후 200 반환
    * 컨슈머 클러스터
      * 메시지 소비하고 알림 이벤트 생성, 관련 채널 큐에 생성
      * 큐는 각 알림 채널에 대한 별도의 서비스
        * FCM
        * APNs
* 채널서비스와 알림서비스 분리
  * 독립적으로 확장 가능
  * 내결함성이 높아짐
* 각 채널에 대해 카프카 토픽을 프로비저닝 한다
  * 각 우선순위 수준에 대한 카프카 토픽도 가질 수 있다
> 사내에서 대량 광고 메세지를 보낼때, 중요한 인증번호 같은 알림톡도 안보내질 수 있음
* 동기식 요청-응답이 아닌 카프카를 사용하는 방식
  * 결합도 감소, 독립적 개발, 과거 메시지 재생을 통한 쉬운 문제 해결, 높은 처리량
  * 대신 저장비용이 수반됨
## 9.4 객체 스토리지: 알림 구성과 전송
* 알림에는 큰 파일이 포함될 수 있음
  * 전화통화 알림 : 오디오
  * 이메일 알림 : 여러 비디오 첨부 파일
* 백엔드는 원본 객체 대신 객체 저장소에 저장해서 객체 ID를 포함하는 알림 이벤트를 발행해 해결
## 9.5 알림 템플릿
### 9.5.1 알림 템플릿 서비스
* 알림 내용은 모든 수신자에게 동일할 가능성이 높다
* 클라이언트는 알림에 템플릿 ID만 포함하면 되고, 채널 서비스는 알림을 생성할 때 템플릿 서비스에서 템플릿을 GET 한다
### 9.5.2 추가 기능
* 저작, 접근제어, 변경 관리
  * 템플릿 권한 관리 : LDAP 과 같은 사용자 관리 서비스와 통합될 필요 있음
  * 변경 이력 기록 관리
  * 변경 승인 프로세스 (관리자 승인)
* 재사용 가능하고 확장 가능한 템플릿 클래스와 함수
  * 템플릿의 매개 변수는 변수 또는 함수
  * 변수는 정수, varchar등 특정 데이터 유형을 가질 수 있고 백엔드가 검증
  * 동적 매개변수를 채우는데 필요한 데이터를 제공하는 시스템과 통합 필요
* 검색
  * 템플릿 검색 기능 제공
* 기타사항
  * 템플릿에서 CSS와 자바스크립트 관리
## 9.6 예약된 알림
* 백엔드 서비스는 알림을 예약하기 위한 API 엔드포인트 제공
* 예약된 알림을 생성할때 에어플로 서비스에 적절한 요청을 생성하고 보낼 수 있음
## 9.7 알림 수신자 그룹
* 사용자가 알림 전달을 요청할 때 요청에는 수신자 그룹 ID 목록이 포함 될 수 있음
* 수신자 그룹 서비스 설계
  * 접근제어 (10억명이 넘는 사용자에게 알림을 보낼 수 있음)
  * 수신자가 스팸 수신 거부할 수 있게 허용
  * 발송전 수동 검토와 승인 프로세스
## 9.8 구독 취소 요청
* 수신자가 구독을 취소할 수 있는 버튼이 포함되어야함
* 백엔드는 알림을 구독 취소하는 카테고리, API 엔드포인트 제공
## 9.9 실패한 전달 처리
* 사유
  * 네트워크
  * 기기 전원
  * 모바일 앱 제거
  * 알림 차단
* 타사 전달 서비스는 채널 서비스에 실패응답 반환
  * 채널서비스는 알림 이벤트에 재시도 횟수 추가
  * 재시도 횟수 증가
  * 데드레터 큐 역할을 하는 토픽에 알림 생성
  * 데드레터 큐 소비 후 재시도
  * 재시도가 3번 실패하면, 이를 기록후 주소그룹 서비스에서 제외
## 9.10 중복 알림에 관한 클라이언트 사이드 고려사항
* 풀 요청에 대한 중복 알림을 방지하는 기능은 클라이언트에 구현해야 한다
  * 이미 받은 알림을 로컬스토리지나 SQLLite 에 기록
## 9.11 우선순위
각 우선순위 수준에 대한 별도의 카프카 토픽을 만들 수 있음
## 9.12 검색
사용자가 알림을 검색할 수 있도록 기능 제공
## 9.13 모니터링과 경보
* 사용자(관리자)는 알림 상태를 추적 할 수 있음
* 다양한 통계 모니터링 대시보드를 만들 수 있다
> 매일 수십억명에게 알림이 보내지려면 DB에 쓸 수는 있을까? 책에서도 DB는 안쓰는듯?
## 9.14 알림/경보 서비스의 가용성과 모니터링과 경보
* 외부기기에 설치할 수 있는 클라이언트 데몬 제공
* 서비스는 주기적으로 외부기기에 하트비트를 보냄
* 하트비트를 받지 못하면 서비스에 직접 상태 확인
## 9.15 기타 논의 가능한 주제
* 필요할때 카프카 클러스터의 메모리 양을 조정할 수 있다
* 자동 확장을 고려할 수 있다
  * 줄이는건 새벽 시간에는 알림을 안보내니 컨슈머를 줄이면 될텐데, 컨슈머를 자동으로 늘릴 수 있나?
